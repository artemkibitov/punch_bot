# üìò –¢–ï–•–ù–ò–ß–ï–°–ö–û–ï –ó–ê–î–ê–ù–ò–ï
## EPIC: Roles, Objects, Employees, Shifts

**–í–µ—Ä—Å–∏—è:** 1.0  
**–î–∞—Ç–∞:** 2025-01-XX  
**–°—Ç–∞—Ç—É—Å:** –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ

---

## üìã –°–û–î–ï–†–ñ–ê–ù–ò–ï

1. [–û–±—â–∞—è –±–∏–∑–Ω–µ—Å-–º–æ–¥–µ–ª—å](#1-–æ–±—â–∞—è-–±–∏–∑–Ω–µ—Å-–º–æ–¥–µ–ª—å)
2. [–†–æ–ª–∏ –∏ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞](#2-—Ä–æ–ª–∏-–∏-–ø—Ä–∞–≤–∞-–¥–æ—Å—Ç—É–ø–∞)
3. [–°—É—â–Ω–æ—Å—Ç–∏ –¥–æ–º–µ–Ω–∞](#3-—Å—É—â–Ω–æ—Å—Ç–∏-–¥–æ–º–µ–Ω–∞)
4. [–°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö](#4-—Å—Ö–µ–º–∞-–±–∞–∑—ã-–¥–∞–Ω–Ω—ã—Ö)
5. [FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ —Å—Ü–µ–Ω–∞—Ä–∏–∏](#5-fsm-—Å–æ—Å—Ç–æ—è–Ω–∏—è-–∏-—Å—Ü–µ–Ω–∞—Ä–∏–∏)
6. [API —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤](#6-api-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤)
7. [–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è](#7-—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ-—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è)
8. [–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á](#8-—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ-–∑–∞–¥–∞—á)

---

## 1. –û–ë–©–ê–Ø –ë–ò–ó–ù–ï–°-–ú–û–î–ï–õ–¨

–°–∏—Å—Ç–µ–º–∞ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è **—É—á—ë—Ç–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏ —Ä–∞–±–æ—á–∏—Ö —Å–º–µ–Ω –Ω–∞ –æ–±—ä–µ–∫—Ç–∞—Ö**, —É–ø—Ä–∞–≤–ª—è–µ–º—ã—Ö —á–µ—Ä–µ–∑ Telegram-–±–æ—Ç–∞.

### –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:

- **FSM-first**: –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ FSM
- **–†–æ–ª–µ–≤–∞—è –º–æ–¥–µ–ª—å**: Admin ‚Üí Manager ‚Üí Employee
- **–ò–µ—Ä–∞—Ä—Ö–∏—è –æ–±—ä–µ–∫—Ç–æ–≤**: Manager ‚Üí Object ‚Üí Employee
- **–ê—É–¥–∏—Ç**: –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–∫—Å–∏—Ä—É—é—Ç—Å—è —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –∞–≤—Ç–æ—Ä–∞ –∏ –≤—Ä–µ–º–µ–Ω–∏

---

## 2. –†–û–õ–ò –ò –ü–†–ê–í–ê –î–û–°–¢–£–ü–ê

### 2.1 Admin

**–°—É—â–Ω–æ—Å—Ç—å:** –ì–ª–æ–±–∞–ª—å–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–∏—Å—Ç–µ–º—ã

**–ü—Ä–∞–≤–∞:**
- ‚úÖ –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π (managers, employees, objects, shifts)
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ:
  - managers
  - employees
  - objects
- ‚úÖ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
  - –≥—Ä–∞—Ñ–∏–∫–∏ –æ–±—ä–µ–∫—Ç–æ–≤
  - —Å–º–µ–Ω—ã (planned –∏ actual)
  - —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —á–∞—Å—ã —Ä–∞–±–æ—Ç—ã (workLogs)
- ‚úÖ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª—é–±—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –î–æ—Å—Ç—É–ø –∫ –æ—Ç—á—ë—Ç–∞–º –∏ –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- ‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–º–∏ —Å—Å—ã–ª–∫–∞–º–∏

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:** –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- Admin –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å **–ª—é–±–æ–π —Å—Ü–µ–Ω–∞—Ä–∏–π manager'–∞**
- –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∫ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è–º –¥–ª—è Admin –¥–æ–ª–∂–Ω—ã –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ managerId

---

### 2.2 Manager

**–°—É—â–Ω–æ—Å—Ç—å:** –£–ø—Ä–∞–≤–ª—è—é—â–∏–π –æ–±—ä–µ–∫—Ç–∞–º–∏ –∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏

**–ü—Ä–∞–≤–∞:**
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤
- ‚úÖ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ **—Ç–æ–ª—å–∫–æ —Å–≤–æ–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤**
- ‚úÖ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –Ω–∞ –æ–±—ä–µ–∫—Ç—ã
- ‚úÖ –°–Ω—è—Ç–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ —Å –æ–±—ä–µ–∫—Ç–æ–≤
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö —Å—Å—ã–ª–æ–∫ –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
- ‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–º–µ–Ω–∞–º–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ **–Ω–∞ —Å–≤–æ–∏—Ö –æ–±—ä–µ–∫—Ç–∞—Ö**
- ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–∞—á–∞–ª–∞/–æ–∫–æ–Ω—á–∞–Ω–∏—è —Å–º–µ–Ω
- ‚úÖ –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ —Ä–∞–±–æ—Ç—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
- ‚ùå –ù–µ –≤–∏–¥–∏—Ç —á—É–∂–∏—Ö managers
- ‚ùå –ù–µ –≤–∏–¥–∏—Ç –æ–±—ä–µ–∫—Ç—ã –¥—Ä—É–≥–∏—Ö managers
- ‚ùå –ù–µ –º–æ–∂–µ—Ç –ø—Ä–∞–≤–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∫ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è–º –¥–ª—è Manager –¥–æ–ª–∂–Ω—ã —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å—Å—è –ø–æ `managerId`
- Manager –º–æ–∂–µ—Ç –±—ã—Ç—å —Ç–∞–∫–∂–µ Employee (dual role)

---

### 2.3 Employee (–†–∞–±–æ—Ç–Ω–∏–∫)

**–°—É—â–Ω–æ—Å—Ç—å:** –ü–∞—Å—Å–∏–≤–Ω–∞—è —Å—É—â–Ω–æ—Å—Ç—å, –≤—ã–ø–æ–ª–Ω—è—é—â–∞—è —Ä–∞–±–æ—Ç—É

**–ü—Ä–∞–≤–∞:**
- ‚úÖ –ü—Ä–∏–≤—è–∑–∫–∞ Telegram-–∞–∫–∫–∞—É–Ω—Ç–∞ –ø–æ ref-—Å—Å—ã–ª–∫–µ
- ‚úÖ –ü—Ä–æ—Å–º–æ—Ç—Ä:
  - —Å–≤–æ–∏—Ö —Å–º–µ–Ω
  - –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞–±–æ—Ç—ã
  - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ —á–∞—Å–∞–º
- ‚úÖ –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ:
  - –Ω–∞—á–∞–ª–∞ —Å–º–µ–Ω—ã (check-in)
  - –æ–∫–æ–Ω—á–∞–Ω–∏—è —Å–º–µ–Ω—ã (check-out)

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
- ‚ùå –ù–µ —É–ø—Ä–∞–≤–ª—è–µ—Ç –æ–±—ä–µ–∫—Ç–∞–º–∏
- ‚ùå –ù–µ –≤–∏–¥–∏—Ç –¥—Ä—É–≥–∏—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
- ‚ùå –ù–µ –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–º–µ–Ω—ã

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- Employee –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ–±—ä–µ–∫—Ç–æ–≤
- Employee –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ —Ä–∞–∑–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–∞—Ö –≤ –æ–¥–∏–Ω –¥–µ–Ω—å (—Ä–∞–∑–Ω—ã–µ —Å–º–µ–Ω—ã)

---

## 3. –°–£–©–ù–û–°–¢–ò –î–û–ú–ï–ù–ê

### 3.1 Manager

**–¢–∞–±–ª–∏—Ü–∞:** `employees` (—Å `role_id = MANAGER`)

**–ü–æ–ª—è:**
```sql
id              INTEGER PRIMARY KEY
telegram_user_id BIGINT UNIQUE NOT NULL
full_name        TEXT NOT NULL
role_id          INTEGER ‚Üí roles(id) [MANAGER]
status           TEXT [active, blocked] DEFAULT 'active'
created_by       INTEGER ‚Üí employees(id) [nullable, –¥–ª—è –∞–¥–º–∏–Ω–∞]
created_at       TIMESTAMP
updated_at       TIMESTAMP
```

**–°–≤—è–∑–∏:**
- 1 ‚Üí N `work_objects` (—á–µ—Ä–µ–∑ `manager_id`)
- 1 ‚Üí N `employees` (—á–µ—Ä–µ–∑ assignments –Ω–∞ –æ–±—ä–µ–∫—Ç–∞—Ö)

**–ë–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞:**
- Manager —Å–æ–∑–¥–∞—ë—Ç—Å—è —á–µ—Ä–µ–∑ onboarding (PIN + –∏–º—è)
- Manager –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∞–¥–º–∏–Ω–æ–º
- Manager –º–æ–∂–µ—Ç –±—ã—Ç—å —Ç–∞–∫–∂–µ Employee (dual role)

---

### 3.2 Object (–û–±—ä–µ–∫—Ç / Work Object)

**–¢–∞–±–ª–∏—Ü–∞:** `work_objects`

**–ü–æ–ª—è:**
```sql
id              INTEGER PRIMARY KEY
manager_id      INTEGER ‚Üí employees(id) [NOT NULL]
name            TEXT NOT NULL
timezone        TEXT NOT NULL DEFAULT 'UTC' [IANA timezone]
planned_start   TIME NOT NULL [–Ω–∞–ø—Ä–∏–º–µ—Ä, '08:00']
planned_end     TIME NOT NULL [–Ω–∞–ø—Ä–∏–º–µ—Ä, '18:00']
lunch_minutes   INTEGER NOT NULL DEFAULT 30
status          work_object_status [ACTIVE, ARCHIVED] DEFAULT 'ACTIVE'
created_at      TIMESTAMP
updated_at      TIMESTAMP
```

**–°–≤—è–∑–∏:**
- N ‚Üí M `employees` (—á–µ—Ä–µ–∑ `assignments`)
- 1 ‚Üí N `shifts` (–ø–æ –¥–Ω—è–º)

**–ë–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞:**
- –ì—Ä–∞—Ñ–∏–∫ –æ–±—ä–µ–∫—Ç–∞ (`planned_start`, `planned_end`, `lunch_minutes`) ‚Äî –±–∞–∑–æ–≤—ã–π –¥–ª—è –≤—Å–µ—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
- –ú–æ–∂–µ—Ç –±—ã—Ç—å –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ (–≤ `work_logs`)
- –û–±—ä–µ–∫—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω (–Ω–µ —É–¥–∞–ª—è–µ—Ç—Å—è)
- Timezone –æ–±—ä–µ–∫—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤—Å–µ—Ö —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ –∏ —Ä–∞—Å—á—ë—Ç–æ–≤

---

### 3.3 Employee (–†–∞–±–æ—Ç–Ω–∏–∫)

**–¢–∞–±–ª–∏—Ü–∞:** `employees` (—Å `role_id = EMPLOYEE`)

**–ü–æ–ª—è:**
```sql
id              INTEGER PRIMARY KEY
telegram_user_id BIGINT UNIQUE [nullable, –¥–æ –ø—Ä–∏–≤—è–∑–∫–∏]
full_name       TEXT NOT NULL
role_id         INTEGER ‚Üí roles(id) [EMPLOYEE]
status          TEXT [active, inactive] DEFAULT 'active'
ref_code        TEXT UNIQUE [nullable, –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏]
ref_code_expires_at TIMESTAMP [nullable]
created_by      INTEGER ‚Üí employees(id) [manager, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–∑–¥–∞–ª]
created_at      TIMESTAMP
updated_at      TIMESTAMP
```

**–°–≤—è–∑–∏:**
- N ‚Üí M `work_objects` (—á–µ—Ä–µ–∑ `assignments`)
- 1 ‚Üí N `work_logs` (—Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —á–∞—Å—ã —Ä–∞–±–æ—Ç—ã)
- 1 ‚Üí N `shifts` (–ø–ª–∞–Ω–∏—Ä—É–µ–º—ã–µ —Å–º–µ–Ω—ã)

**–ë–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞:**
- Employee —Å–æ–∑–¥–∞—ë—Ç—Å—è manager'–æ–º (–±–µ–∑ telegramId)
- –ü—Ä–∏–≤—è–∑–∫–∞ Telegram –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ ref-—Å—Å—ã–ª–∫–µ
- Employee –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –æ–±—ä–µ–∫—Ç–∞—Ö –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- Employee –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–º–µ–Ω –≤ –¥–µ–Ω—å (–Ω–∞ —Ä–∞–∑–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–∞—Ö)

---

### 3.4 Assignment (–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –Ω–∞ –æ–±—ä–µ–∫—Ç)

**–¢–∞–±–ª–∏—Ü–∞:** `assignments` (—É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å)

**–¢–µ–∫—É—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```sql
id              INTEGER PRIMARY KEY
employee_id     INTEGER ‚Üí employees(id)
work_object_id  INTEGER ‚Üí work_objects(id)
assigned_at     TIMESTAMP
unassigned_at   TIMESTAMP [nullable]
```

**–ù—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å:**
```sql
ALTER TABLE assignments
  ADD COLUMN assigned_by INTEGER REFERENCES employees(id);

-- –û–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–ø–∏—Å–∏ (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å)
-- UPDATE assignments SET assigned_by = ... WHERE assigned_by IS NULL;
```

**–ë–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞:**
- –°–æ—Ç—Ä—É–¥–Ω–∏–∫ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ–±—ä–µ–∫—Ç–æ–≤
- –°–Ω—è—Ç–∏–µ —Å –æ–±—ä–µ–∫—Ç–∞ –Ω–µ —É–¥–∞–ª—è–µ—Ç –∑–∞–ø–∏—Å—å, —Å—Ç–∞–≤–∏—Ç `unassigned_at`
- –ê–∫—Ç–∏–≤–Ω—ã–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è: `unassigned_at IS NULL`

---

### 3.5 Shift (–°–º–µ–Ω–∞)

**–¢–∞–±–ª–∏—Ü–∞:** `shifts`

**–ü–æ–ª—è:**
```sql
id              INTEGER PRIMARY KEY
work_object_id  INTEGER ‚Üí work_objects(id)
date            DATE NOT NULL
planned_start   TIMESTAMP NOT NULL [date + planned_start –∏–∑ –æ–±—ä–µ–∫—Ç–∞]
planned_end     TIMESTAMP NOT NULL [date + planned_end –∏–∑ –æ–±—ä–µ–∫—Ç–∞]
lunch_minutes   INTEGER NOT NULL [–∏–∑ –æ–±—ä–µ–∫—Ç–∞]
status          TEXT [planned, started, closed] DEFAULT 'planned'
started_at      TIMESTAMP [nullable, –∫–æ–≥–¥–∞ manager –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –Ω–∞—á–∞–ª–æ]
closed_at       TIMESTAMP [nullable, –∫–æ–≥–¥–∞ manager –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –æ–∫–æ–Ω—á–∞–Ω–∏–µ]
confirmed_by    INTEGER ‚Üí employees(id) [manager, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª]
created_at      TIMESTAMP
updated_at      TIMESTAMP
```

**–ë–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞:**
- –°–º–µ–Ω–∞ —Å–æ–∑–¥–∞—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ –Ω–∞ –∫–∞–∂–¥—ã–π —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å
- –°—Ç–∞—Ç—É—Å—ã:
  - `planned`: —Å–æ–∑–¥–∞–Ω–∞, –Ω–æ –Ω–µ –Ω–∞—á–∞–ª–∞—Å—å
  - `started`: manager –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –Ω–∞—á–∞–ª–æ, —Å–æ–∑–¥–∞–Ω—ã work_logs
  - `closed`: manager –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –æ–∫–æ–Ω—á–∞–Ω–∏–µ, –≤—Å–µ work_logs –∑–∞–∫—Ä—ã—Ç—ã
- –°–º–µ–Ω–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–µ—Ä–µ–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ (–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞)

---

### 3.6 WorkLog (–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —É—á—ë—Ç –≤—Ä–µ–º–µ–Ω–∏)

**–¢–∞–±–ª–∏—Ü–∞:** `work_logs` (–Ω–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞)

**–ü–æ–ª—è:**
```sql
id              INTEGER PRIMARY KEY
employee_id     INTEGER ‚Üí employees(id)
work_object_id  INTEGER ‚Üí work_objects(id)
shift_id        INTEGER ‚Üí shifts(id) [nullable, –µ—Å–ª–∏ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞]
date            DATE NOT NULL
actual_start    TIMESTAMP NOT NULL
actual_end      TIMESTAMP [nullable, –¥–æ –∑–∞–∫—Ä—ã—Ç–∏—è —Å–º–µ–Ω—ã]
lunch_minutes   INTEGER DEFAULT 0
is_override     BOOLEAN DEFAULT false [true, –µ—Å–ª–∏ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞]
created_by      INTEGER ‚Üí employees(id) [manager –∏–ª–∏ admin]
created_at      TIMESTAMP
updated_at      TIMESTAMP
```

**–ë–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞:**
- WorkLog —Å–æ–∑–¥–∞—ë—Ç—Å—è –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –Ω–∞—á–∞–ª–∞ —Å–º–µ–Ω—ã
- `actual_end` –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è
- –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞: `is_override = true`
- WorkLog –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω/–∏–∑–º–µ–Ω—ë–Ω —Ç–æ–ª—å–∫–æ manager'–æ–º –∏–ª–∏ admin'–æ–º

---

### 3.7 ReferralToken (–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞)

**–¢–∞–±–ª–∏—Ü–∞:** `referral_tokens` (—É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è)

**–¢–µ–∫—É—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```sql
id              INTEGER PRIMARY KEY
token           TEXT UNIQUE NOT NULL
manager_id      INTEGER ‚Üí employees(id) [NOT NULL]
expires_at      TIMESTAMP NOT NULL
used_at         TIMESTAMP [nullable]
created_at      TIMESTAMP
```

**–ù—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å:**
```sql
-- –î–æ–±–∞–≤–∏—Ç—å employee_id –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É
ALTER TABLE referral_tokens
  ADD COLUMN employee_id INTEGER REFERENCES employees(id);

-- –û–±–Ω–æ–≤–∏—Ç—å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É:
-- –ï—Å–ª–∏ employee_id —É–∫–∞–∑–∞–Ω ‚Üí –ø—Ä–∏–≤—è–∑–∫–∞ –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É
-- –ï—Å–ª–∏ employee_id NULL ‚Üí —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
```

**–ë–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞:**
- Token –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π (`used_at` —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ)
- –ú–æ–∂–µ—Ç –∏–º–µ—Ç—å TTL (`expires_at`)
- –ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ —Å–≤—è–∑—ã–≤–∞–µ—Ç `telegram_user_id` —Å `employee_id`
- –ï—Å–ª–∏ `employee_id` NULL ‚Üí —Å–æ–∑–¥–∞—ë—Ç—Å—è –Ω–æ–≤—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫

---

### 3.8 AuditLog (–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π)

**–¢–∞–±–ª–∏—Ü–∞:** `audit_logs` (–Ω–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞)

**–ü–æ–ª—è:**
```sql
id              INTEGER PRIMARY KEY
entity_type     TEXT NOT NULL [employees, work_objects, shifts, work_logs]
entity_id       INTEGER NOT NULL
action          TEXT NOT NULL [create, update, delete]
field_name      TEXT [nullable, –¥–ª—è update]
old_value       JSONB [nullable]
new_value       JSONB [nullable]
changed_by      INTEGER ‚Üí employees(id) [NOT NULL]
changed_at      TIMESTAMP NOT NULL DEFAULT now()
metadata        JSONB [–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è]
```

**–ë–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞:**
- –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π —Ñ–∏–∫—Å–∏—Ä—É—é—Ç—Å—è
- Admin –º–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å –ø–æ–ª–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é
- Manager –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ —Å–≤–æ–∏–º –æ–±—ä–µ–∫—Ç–∞–º

---

## 4. –°–•–ï–ú–ê –ë–ê–ó–´ –î–ê–ù–ù–´–•

### 4.1 –ù–æ–≤—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏

#### –ú–∏–≥—Ä–∞—Ü–∏—è 012: –î–æ–±–∞–≤–∏—Ç—å —Ä–æ–ª—å ADMIN

```sql
-- –î–æ–±–∞–≤–∏—Ç—å ADMIN –≤ role_type enum
ALTER TYPE role_type ADD VALUE 'ADMIN';

-- –í—Å—Ç–∞–≤–∏—Ç—å —Ä–æ–ª—å ADMIN
INSERT INTO roles (code) VALUES ('ADMIN');
```

#### –ú–∏–≥—Ä–∞—Ü–∏—è 013: –†–∞—Å—à–∏—Ä–∏—Ç—å work_objects

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –¢–∞–±–ª–∏—Ü–∞ `work_objects` —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è.

```sql
ALTER TABLE work_objects
  ADD COLUMN manager_id INTEGER REFERENCES employees(id),
  ADD COLUMN timezone TEXT NOT NULL DEFAULT 'UTC',
  ADD COLUMN planned_start TIME NOT NULL DEFAULT '08:00',
  ADD COLUMN planned_end TIME NOT NULL DEFAULT '18:00',
  ADD COLUMN lunch_minutes INTEGER NOT NULL DEFAULT 30;

-- –û–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ–±—ä–µ–∫—Ç—ã: manager_id = created_by
UPDATE work_objects SET manager_id = created_by WHERE manager_id IS NULL;

-- –°–¥–µ–ª–∞—Ç—å manager_id –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º
ALTER TABLE work_objects
  ALTER COLUMN manager_id SET NOT NULL;
```

#### –ú–∏–≥—Ä–∞—Ü–∏—è 014: –°–æ–∑–¥–∞—Ç—å work_logs

```sql
CREATE TABLE work_logs (
  id SERIAL PRIMARY KEY,
  employee_id INTEGER NOT NULL REFERENCES employees(id),
  work_object_id INTEGER NOT NULL REFERENCES work_objects(id),
  shift_id INTEGER REFERENCES shifts(id),
  date DATE NOT NULL,
  actual_start TIMESTAMP NOT NULL,
  actual_end TIMESTAMP,
  lunch_minutes INTEGER NOT NULL DEFAULT 0,
  is_override BOOLEAN NOT NULL DEFAULT false,
  created_by INTEGER NOT NULL REFERENCES employees(id),
  created_at TIMESTAMP NOT NULL DEFAULT now(),
  updated_at TIMESTAMP NOT NULL DEFAULT now()
);

CREATE INDEX idx_work_logs_employee_date 
  ON work_logs(employee_id, date);
CREATE INDEX idx_work_logs_work_object_date 
  ON work_logs(work_object_id, date);
CREATE INDEX idx_work_logs_shift 
  ON work_logs(shift_id);
```

#### –ú–∏–≥—Ä–∞—Ü–∏—è 015: –û–±–Ω–æ–≤–∏—Ç—å shifts

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –¢–∞–±–ª–∏—Ü–∞ `shifts` —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è. –ù—É–∂–Ω–æ –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å –º–æ–¥–µ–ª—å.

**–í–∞—Ä–∏–∞–Ω—Ç 1 (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π):** –°–º–µ–Ω–∞ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –æ–±—ä–µ–∫—Ç—É, –∞ –Ω–µ –∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É.

```sql
-- –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è –¥–ª—è –Ω–æ–≤–æ–π –º–æ–¥–µ–ª–∏
ALTER TABLE shifts
  ADD COLUMN status TEXT NOT NULL DEFAULT 'planned',
  ADD COLUMN started_at TIMESTAMP,
  ADD COLUMN closed_at TIMESTAMP,
  ADD COLUMN confirmed_by INTEGER REFERENCES employees(id),
  ADD COLUMN updated_at TIMESTAMP NOT NULL DEFAULT now();

-- –í–ê–ñ–ù–û: –¢–µ–∫—É—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ shifts (employee_id) –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –Ω–æ–≤–æ–π –º–æ–¥–µ–ª–∏
-- –ù—É–∂–Ω–æ —Ä–µ—à–∏—Ç—å: –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É
-- –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ: –æ—Å—Ç–∞–≤–∏—Ç—å —Å—Ç–∞—Ä—É—é —Ç–∞–±–ª–∏—Ü—É –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏, —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –¥–ª—è –Ω–æ–≤–æ–π –º–æ–¥–µ–ª–∏
```

**–í–∞—Ä–∏–∞–Ω—Ç 2:** –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—É—â—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–æ–¥ –Ω–æ–≤—É—é –º–æ–¥–µ–ª—å (—Å–º–µ–Ω–∞ = –æ–±—ä–µ–∫—Ç + –¥–∞—Ç–∞, –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É).

```sql
-- –£–¥–∞–ª–∏—Ç—å employee_id –∏–∑ shifts (–µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å)
-- –°–º–µ–Ω–∞ —Ç–µ–ø–µ—Ä—å –æ—Ç–Ω–æ—Å–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫ –æ–±—ä–µ–∫—Ç—É
ALTER TABLE shifts
  DROP COLUMN IF EXISTS employee_id,
  ADD COLUMN status TEXT NOT NULL DEFAULT 'planned',
  ADD COLUMN started_at TIMESTAMP,
  ADD COLUMN closed_at TIMESTAMP,
  ADD COLUMN confirmed_by INTEGER REFERENCES employees(id),
  ADD COLUMN updated_at TIMESTAMP NOT NULL DEFAULT now();
```

#### –ú–∏–≥—Ä–∞—Ü–∏—è 016: –°–æ–∑–¥–∞—Ç—å audit_logs

```sql
CREATE TABLE audit_logs (
  id SERIAL PRIMARY KEY,
  entity_type TEXT NOT NULL,
  entity_id INTEGER NOT NULL,
  action TEXT NOT NULL,
  field_name TEXT,
  old_value JSONB,
  new_value JSONB,
  changed_by INTEGER NOT NULL REFERENCES employees(id),
  changed_at TIMESTAMP NOT NULL DEFAULT now(),
  metadata JSONB
);

CREATE INDEX idx_audit_logs_entity 
  ON audit_logs(entity_type, entity_id);
CREATE INDEX idx_audit_logs_changed_by 
  ON audit_logs(changed_by);
CREATE INDEX idx_audit_logs_changed_at 
  ON audit_logs(changed_at);
```

#### –ú–∏–≥—Ä–∞—Ü–∏—è 017: –†–∞—Å—à–∏—Ä–∏—Ç—å employees

```sql
ALTER TABLE employees
  ADD COLUMN status TEXT NOT NULL DEFAULT 'active',
  ADD COLUMN ref_code TEXT UNIQUE,
  ADD COLUMN ref_code_expires_at TIMESTAMP,
  ADD COLUMN updated_at TIMESTAMP NOT NULL DEFAULT now();
```

---

## 5. FSM –°–û–°–¢–û–Ø–ù–ò–Ø –ò –°–¶–ï–ù–ê–†–ò–ò

### 5.1 –ù–æ–≤—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è

```javascript
// app/domain/fsm/states.js

export const STATES = Object.freeze({
  // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ ...
  
  // Admin
  ADMIN_MENU: 'ADMIN_MENU',
  ADMIN_OBJECTS_LIST: 'ADMIN_OBJECTS_LIST',
  ADMIN_EMPLOYEES_LIST: 'ADMIN_EMPLOYEES_LIST',
  
  // Manager - Objects
  MANAGER_OBJECTS_LIST: 'MANAGER_OBJECTS_LIST',
  OBJECT_CREATE_ENTER_NAME: 'OBJECT_CREATE_ENTER_NAME',
  OBJECT_CREATE_ENTER_SCHEDULE: 'OBJECT_CREATE_ENTER_SCHEDULE',
  OBJECT_DETAILS: 'OBJECT_DETAILS',
  OBJECT_EDIT: 'OBJECT_EDIT',
  
  // Manager - Employees
  OBJECT_EMPLOYEES_LIST: 'OBJECT_EMPLOYEES_LIST',
  EMPLOYEE_CREATE_ENTER_NAME: 'EMPLOYEE_CREATE_ENTER_NAME',
  EMPLOYEE_DETAILS: 'EMPLOYEE_DETAILS',
  EMPLOYEE_EDIT_TIME: 'EMPLOYEE_EDIT_TIME',
  
  // Manager - Shifts
  SHIFT_START_CONFIRMATION: 'SHIFT_START_CONFIRMATION',
  SHIFT_START_MARK_ABSENT: 'SHIFT_START_MARK_ABSENT',
  SHIFT_START_ENTER_ABSENT_IDS: 'SHIFT_START_ENTER_ABSENT_IDS',
  SHIFT_END_CONFIRMATION: 'SHIFT_END_CONFIRMATION',
  SHIFT_END_MARK_OVERTIME: 'SHIFT_END_MARK_OVERTIME',
  SHIFT_END_ENTER_OVERTIME_IDS: 'SHIFT_END_ENTER_OVERTIME_IDS',
  SHIFT_END_ENTER_OVERTIME_TIME: 'SHIFT_END_ENTER_OVERTIME_TIME',
  
  // Employee
  EMPLOYEE_REF_LINK_ACTIVATE: 'EMPLOYEE_REF_LINK_ACTIVATE',
});
```

### 5.2 –°—Ü–µ–Ω–∞—Ä–∏–∏ FSM

#### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ (Manager)

```
MANAGER_MENU
  ‚Üí [object:create] ‚Üí OBJECT_CREATE_ENTER_NAME
    ‚Üí [text: "–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞"] ‚Üí OBJECT_CREATE_ENTER_SCHEDULE
      ‚Üí [text: "08:00 18:00 30"] ‚Üí OBJECT_DETAILS
        ‚Üí [back] ‚Üí MANAGER_OBJECTS_LIST
```

**–§–∞–π–ª—ã:**
- `app/application/fsm/states/objectCreateEnterName.js`
- `app/application/fsm/states/objectCreateEnterSchedule.js`

#### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–∞—á–∞–ª–∞ —Å–º–µ–Ω—ã (Manager)

```
[–¢—Ä–∏–≥–≥–µ—Ä: planned_start –æ–±—ä–µ–∫—Ç–∞]
  ‚Üí SHIFT_START_CONFIRMATION
    ‚Üí [all_present] ‚Üí [—Å–æ–∑–¥–∞—Ç—å work_logs] ‚Üí MANAGER_MENU
    ‚Üí [mark_absent] ‚Üí SHIFT_START_MARK_ABSENT
      ‚Üí SHIFT_START_ENTER_ABSENT_IDS
        ‚Üí [text: "2 12"] ‚Üí [–≤–∞–ª–∏–¥–∞—Ü–∏—è] ‚Üí [—Å–æ–∑–¥–∞—Ç—å work_logs] ‚Üí MANAGER_MENU
```

**–§–∞–π–ª—ã:**
- `app/application/fsm/states/shiftStartConfirmation.js`
- `app/application/fsm/states/shiftStartMarkAbsent.js`
- `app/application/fsm/states/shiftStartEnterAbsentIds.js`

#### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Å–º–µ–Ω—ã (Manager)

```
[–¢—Ä–∏–≥–≥–µ—Ä: planned_end –æ–±—ä–µ–∫—Ç–∞]
  ‚Üí SHIFT_END_CONFIRMATION
    ‚Üí [all_finished] ‚Üí [–∑–∞–∫—Ä—ã—Ç—å work_logs] ‚Üí MANAGER_MENU
    ‚Üí [mark_overtime] ‚Üí SHIFT_END_MARK_OVERTIME
      ‚Üí SHIFT_END_ENTER_OVERTIME_IDS
        ‚Üí [text: "5 7"] ‚Üí SHIFT_END_ENTER_OVERTIME_TIME
          ‚Üí [text: "19:30"] ‚Üí [–æ–±–Ω–æ–≤–∏—Ç—å work_logs] ‚Üí MANAGER_MENU
```

**–§–∞–π–ª—ã:**
- `app/application/fsm/states/shiftEndConfirmation.js`
- `app/application/fsm/states/shiftEndMarkOvertime.js`
- `app/application/fsm/states/shiftEndEnterOvertimeIds.js`
- `app/application/fsm/states/shiftEndEnterOvertimeTime.js`

#### –°—Ü–µ–Ω–∞—Ä–∏–π 4: –ê–∫—Ç–∏–≤–∞—Ü–∏—è ref-—Å—Å—ã–ª–∫–∏ (Employee)

```
[–ü–µ—Ä–µ—Ö–æ–¥ –ø–æ —Å—Å—ã–ª–∫–µ: /start?ref=TOKEN]
  ‚Üí EMPLOYEE_REF_LINK_ACTIVATE
    ‚Üí [–≤–∞–ª–∏–¥–∞—Ü–∏—è token] ‚Üí [–ø—Ä–∏–≤—è–∑–∫–∞ telegramId] ‚Üí EMPLOYEE_MENU
```

**–§–∞–π–ª—ã:**
- `app/application/fsm/states/employeeRefLinkActivate.js`

---

## 6. API –†–ï–ü–û–ó–ò–¢–û–†–ò–ï–í

### 6.1 ObjectRepository

**–§–∞–π–ª:** `app/infrastructure/repositories/objectRepository.js`

```javascript
class ObjectRepository {
  // –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞
  async create({ managerId, name, timezone, plannedStart, plannedEnd, lunchMinutes })
  
  // –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ (—Å —Ñ–∏–ª—å—Ç—Ä–æ–º –¥–ª—è Admin)
  async findByManagerId(managerId, { includeArchived = false })
  
  // –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ –ø–æ ID (—Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø—Ä–∞–≤)
  async findById(objectId, { managerId = null, isAdmin = false })
  
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞
  async update(objectId, updates, { managerId = null, isAdmin = false })
  
  // –ê—Ä—Ö–∏–≤–∞—Ü–∏—è –æ–±—ä–µ–∫—Ç–∞
  async archive(objectId, { managerId = null, isAdmin = false })
  
  // –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –¥–ª—è —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤
  async findActiveForTrigger(date, time)
}
```

### 6.2 EmployeeRepository (—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ)

**–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã:**

```javascript
// –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ (–±–µ–∑ telegramId)
async createEmployee({ fullName, createdBy })

// –ü–æ–∏—Å–∫ –ø–æ ref_code
async findByRefCode(refCode)

// –ü—Ä–∏–≤—è–∑–∫–∞ Telegram
async linkTelegram(employeeId, telegramUserId)

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –æ–±—ä–µ–∫—Ç–∞
async findByObjectId(objectId, { managerId = null, isAdmin = false })

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –º–µ–Ω–µ–¥–∂–µ—Ä–∞
async findByManagerId(managerId, { includeInactive = false })
```

### 6.3 AssignmentRepository

**–§–∞–π–ª:** `app/infrastructure/repositories/assignmentRepository.js`

```javascript
class AssignmentRepository {
  // –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –Ω–∞ –æ–±—ä–µ–∫—Ç
  async assign({ employeeId, workObjectId, assignedBy })
  
  // –°–Ω—è—Ç–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ —Å –æ–±—ä–µ–∫—Ç–∞
  async remove({ employeeId, workObjectId, removedBy })
  
  // –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π –æ–±—ä–µ–∫—Ç–∞
  async findActiveByObjectId(objectId)
  
  // –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
  async findObjectsByEmployeeId(employeeId)
}
```

### 6.4 ShiftRepository

**–§–∞–π–ª:** `app/infrastructure/repositories/shiftRepository.js`

```javascript
class ShiftRepository {
  // –°–æ–∑–¥–∞–Ω–∏–µ —Å–º–µ–Ω—ã (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
  async create({ workObjectId, date, plannedStart, plannedEnd, lunchMinutes })
  
  // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–º–µ–Ω—ã –æ–±—ä–µ–∫—Ç–∞ –Ω–∞ –¥–∞—Ç—É
  async findByObjectAndDate(objectId, date)
  
  // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–∞—á–∞–ª–∞ —Å–º–µ–Ω—ã
  async confirmStart(shiftId, { confirmedBy })
  
  // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Å–º–µ–Ω—ã
  async confirmEnd(shiftId, { confirmedBy })
  
  // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–º–µ–Ω –¥–ª—è —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤
  async findForTrigger(date, time, status)
}
```

### 6.5 WorkLogRepository

**–§–∞–π–ª:** `app/infrastructure/repositories/workLogRepository.js`

```javascript
class WorkLogRepository {
  // –°–æ–∑–¥–∞–Ω–∏–µ work_log (–ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –Ω–∞—á–∞–ª–∞)
  async create({ employeeId, workObjectId, shiftId, date, actualStart, createdBy })
  
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ work_log (–ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è)
  async updateEnd(workLogId, { actualEnd, updatedBy })
  
  // –ü–æ–ª—É—á–µ–Ω–∏–µ work_logs —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
  async findByEmployeeId(employeeId, { dateFrom, dateTo })
  
  // –ü–æ–ª—É—á–µ–Ω–∏–µ work_logs –æ–±—ä–µ–∫—Ç–∞ –Ω–∞ –¥–∞—Ç—É
  async findByObjectAndDate(objectId, date)
  
  // –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞
  async createOverride({ employeeId, workObjectId, date, actualStart, actualEnd, createdBy })
}
```

### 6.6 AuditLogRepository

**–§–∞–π–ª:** `app/infrastructure/repositories/auditLogRepository.js`

```javascript
class AuditLogRepository {
  // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
  async log({ entityType, entityId, action, fieldName, oldValue, newValue, changedBy, metadata })
  
  // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Å—É—â–Ω–æ—Å—Ç–∏
  async findByEntity(entityType, entityId, { managerId = null, isAdmin = false })
}
```

---

## 7. –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø

### 7.1 –¢—Ä–∏–≥–≥–µ—Ä—ã —Å–º–µ–Ω

**–§–∞–π–ª:** `app/infrastructure/scheduler/shiftTrigger.js`

**–ó–∞–¥–∞—á–∞:** –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ (–∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É) –ø—Ä–æ–≤–µ—Ä—è—Ç—å –æ–±—ä–µ–∫—Ç—ã –∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è —Å–º–µ–Ω.

**–õ–æ–≥–∏–∫–∞:**
1. –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã
2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:
   - –ï—Å—Ç—å –ª–∏ —Å–º–µ–Ω–∞ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è?
   - –ï—Å–ª–∏ –Ω–µ—Ç ‚Üí —Å–æ–∑–¥–∞—Ç—å —Å–º–µ–Ω—É —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `planned`
   - –ï—Å–ª–∏ `planned` –∏ –≤—Ä–µ–º—è = `planned_start` ‚Üí –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ manager'—É
   - –ï—Å–ª–∏ `started` –∏ –≤—Ä–µ–º—è = `planned_end` ‚Üí –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ manager'—É

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `node-cron` –∏–ª–∏ –ø–æ–¥–æ–±–Ω–æ–µ
- –£—á–∏—Ç—ã–≤–∞—Ç—å timezone –æ–±—ä–µ–∫—Ç–∞
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –æ—à–∏–±–∫–∏ gracefully

### 7.2 –í–∞–ª–∏–¥–∞—Ü–∏—è –≤ FSM

**–ü—Ä–∏–Ω—Ü–∏–ø—ã:**
- –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –≤–≤–æ–¥—ã –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è –≤ `onInput`
- –ü—Ä–∏ –æ—à–∏–±–∫–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –æ—Å—Ç–∞—ë–º—Å—è –≤ —Ç–æ–º –∂–µ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
- –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ

**–ü—Ä–∏–º–µ—Ä—ã –≤–∞–ª–∏–¥–∞—Ü–∏–∏:**
- ID —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤: —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–∞, —Ä–∞–∑–¥–µ–ª—ë–Ω–Ω—ã–µ –ø—Ä–æ–±–µ–ª–∞–º–∏
- –í—Ä–µ–º—è: —Ñ–æ—Ä–º–∞—Ç HH:MM, –≤–∞–ª–∏–¥–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
- –ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞: –Ω–µ –ø—É—Å—Ç–æ–µ, max 100 —Å–∏–º–≤–æ–ª–æ–≤

### 7.3 –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

**–°—Ç—Ä–∞—Ç–µ–≥–∏—è:**
- –í—Å–µ –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ `audit_logs`
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
- FSM –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–æ–±—ã—á–Ω–æ –º–µ–Ω—é)

### 7.4 –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

**–ü—Ä–æ–≤–µ—Ä–∫–∏:**
- Manager –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å–æ —Å–≤–æ–∏–º–∏ –æ–±—ä–µ–∫—Ç–∞–º–∏
- Admin –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å–æ –≤—Å–µ–º–∏ –æ–±—ä–µ–∫—Ç–∞–º–∏
- Employee –º–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ
- –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–∫—Å–∏—Ä—É—é—Ç—Å—è –≤ `audit_logs`

---

## 8. –†–ê–ó–î–ï–õ–ï–ù–ò–ï –ó–ê–î–ê–ß

### 8.1 Backend Developer #1: –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –∏ –º–∏–≥—Ä–∞—Ü–∏–∏

**–ó–∞–¥–∞—á–∏:**
1. ‚úÖ –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ 012-017
2. ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `ObjectRepository`
3. ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `AssignmentRepository`
4. ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `ShiftRepository`
5. ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `WorkLogRepository`
6. ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `AuditLogRepository`
7. ‚úÖ –†–∞—Å—à–∏—Ä–∏—Ç—å `EmployeeRepository` (–Ω–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã)

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:**
- –í—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–æ—Ö–æ–¥—è—Ç —É—Å–ø–µ—à–Ω–æ
- –í—Å–µ –º–µ—Ç–æ–¥—ã —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤ –ø–æ–∫—Ä—ã—Ç—ã –±–∞–∑–æ–≤—ã–º–∏ —Ç–µ—Å—Ç–∞–º–∏
- –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å —É—á—ë—Ç–æ–º –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞

---

### 8.2 Backend Developer #2: –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –∏ —Å–µ—Ä–≤–∏—Å—ã

**–ó–∞–¥–∞—á–∏:**
1. ‚úÖ –°–æ–∑–¥–∞—Ç—å `ObjectService` (—Å–æ–∑–¥–∞–Ω–∏–µ, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤)
2. ‚úÖ –°–æ–∑–¥–∞—Ç—å `EmployeeService` (—Å–æ–∑–¥–∞–Ω–∏–µ, –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞ –æ–±—ä–µ–∫—Ç—ã)
3. ‚úÖ –°–æ–∑–¥–∞—Ç—å `ShiftService` (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–∞—á–∞–ª–∞/–æ–∫–æ–Ω—á–∞–Ω–∏—è)
4. ‚úÖ –°–æ–∑–¥–∞—Ç—å `WorkLogService` (—Å–æ–∑–¥–∞–Ω–∏–µ, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ work_logs)
5. ‚úÖ –°–æ–∑–¥–∞—Ç—å `ReferralService` (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è ref-—Å—Å—ã–ª–æ–∫)
6. ‚úÖ –°–æ–∑–¥–∞—Ç—å `ShiftTriggerService` (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã)
7. ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å `AuditLogRepository` –≤–æ –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:**
- –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –ø–æ–∫—Ä—ã—Ç—ã unit-—Ç–µ—Å—Ç–∞–º–∏
- –õ–æ–≥–∏–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- –¢—Ä–∏–≥–≥–µ—Ä—ã —Å–º–µ–Ω —Ä–∞–±–æ—Ç–∞—é—Ç –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é

---

### 8.3 FSM Developer: –°–æ—Å—Ç–æ—è–Ω–∏—è –∏ —Å—Ü–µ–Ω–∞—Ä–∏–∏

**–ó–∞–¥–∞—á–∏:**
1. ‚úÖ –°–æ–∑–¥–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –º–µ–Ω—é (Admin, Manager Objects, Employee)
2. ‚úÖ –°–æ–∑–¥–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—ä–µ–∫—Ç–æ–≤
3. ‚úÖ –°–æ–∑–¥–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏
4. ‚úÖ –°–æ–∑–¥–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å–º–µ–Ω
5. ‚úÖ –°–æ–∑–¥–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ ref-—Å—Å—ã–ª–æ–∫
6. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å transitions –≤ `transitions.js`
7. ‚úÖ –°–æ–∑–¥–∞—Ç—å callback handlers –¥–ª—è –Ω–æ–≤—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:**
- –í—Å–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- –í—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –ø—Ä–æ—Ö–æ–¥—è—Ç end-to-end
- –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–æ –≤—Å–µ—Ö —Å–æ—Å—Ç–æ—è–Ω–∏—è—Ö
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞

---

### 8.4 –û–±—â–∏–µ –∑–∞–¥–∞—á–∏ (–≤—Å–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏)

**–ó–∞–¥–∞—á–∏:**
1. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å `resolveStartFlow` –¥–ª—è —É—á—ë—Ç–∞ Admin
2. ‚úÖ –°–æ–∑–¥–∞—Ç—å middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
3. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (–º–µ–Ω—é, –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã)
4. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ –≤—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
5. ‚úÖ –ù–∞–ø–∏—Å–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –ø–æ API —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤

---

## 9. –ü–†–ò–û–†–ò–¢–ï–¢–´ –†–ï–ê–õ–ò–ó–ê–¶–ò–ò

### Phase 1: –ë–∞–∑–æ–≤–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (Week 1)
- –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î
- –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ (Object, Assignment, Shift, WorkLog)
- –ë–∞–∑–æ–≤—ã–µ —Å–µ—Ä–≤–∏—Å—ã

### Phase 2: FSM —Å—Ü–µ–Ω–∞—Ä–∏–∏ (Week 2)
- –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏
- –ë–∞–∑–æ–≤–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–º–µ–Ω

### Phase 3: –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (Week 3)
- –¢—Ä–∏–≥–≥–µ—Ä—ã —Å–º–µ–Ω
- –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –≤—Ä–µ–º–µ–Ω–∏
- Ref-—Å—Å—ã–ª–∫–∏
- Audit logs

### Phase 4: Admin —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª (Week 4)
- Admin –º–µ–Ω—é
- –ì–ª–æ–±–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø
- –û—Ç—á—ë—Ç—ã

---

## 10. –ö–†–ò–¢–ï–†–ò–ò –ü–†–ò–Å–ú–ö–ò

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ:
- ‚úÖ Manager –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å –æ–±—ä–µ–∫—Ç
- ‚úÖ Manager –º–æ–∂–µ—Ç –Ω–∞–∑–Ω–∞—á–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –Ω–∞ –æ–±—ä–µ–∫—Ç
- ‚úÖ Manager –º–æ–∂–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –Ω–∞—á–∞–ª–æ —Å–º–µ–Ω—ã (–≤—Å–µ/—Å –∏—Å–∫–ª—é—á–µ–Ω–∏—è–º–∏)
- ‚úÖ Manager –º–æ–∂–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ–∫–æ–Ω—á–∞–Ω–∏–µ —Å–º–µ–Ω—ã (–≤—Å–µ/—Å –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–æ–π)
- ‚úÖ Employee –º–æ–∂–µ—Ç –ø—Ä–∏–≤—è–∑–∞—Ç—å Telegram –ø–æ ref-—Å—Å—ã–ª–∫–µ
- ‚úÖ Admin –º–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
- ‚úÖ –¢—Ä–∏–≥–≥–µ—Ä—ã —Å–º–µ–Ω —Ä–∞–±–æ—Ç–∞—é—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ:
- ‚úÖ –í—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–æ—Ö–æ–¥—è—Ç —É—Å–ø–µ—à–Ω–æ
- ‚úÖ –í—Å–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –ø–æ–∫—Ä—ã—Ç—ã —Ç–µ—Å—Ç–∞–º–∏
- ‚úÖ –í—Å–µ FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ Audit logs —Ñ–∏–∫—Å–∏—Ä—É—é—Ç –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–µ–∑–¥–µ

---

## 11. –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –†–ï–®–ï–ù–ò–Ø (–¢–†–ï–ë–£–Æ–¢ –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø)

### ‚ö†Ô∏è 11.1 –ú–æ–¥–µ–ª—å —Å–º–µ–Ω (Shifts)

**–ü—Ä–æ–±–ª–µ–º–∞:** –¢–µ–∫—É—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ `shifts` –∏–º–µ–µ—Ç `employee_id`, —á—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç —Å–º–µ–Ω—É –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—É—é –∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É. –ù–æ–≤–∞—è –º–æ–¥–µ–ª—å —Ç—Ä–µ–±—É–µ—Ç —Å–º–µ–Ω—É –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—É—é –∫ –æ–±—ä–µ–∫—Ç—É (–æ–±—ä–µ–∫—Ç + –¥–∞—Ç–∞ = —Å–º–µ–Ω–∞).

**–í–∞—Ä–∏–∞–Ω—Ç—ã —Ä–µ—à–µ–Ω–∏—è:**

**–í–∞—Ä–∏–∞–Ω—Ç A (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π):** –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É `object_shifts`
```sql
CREATE TABLE object_shifts (
  id SERIAL PRIMARY KEY,
  work_object_id INTEGER NOT NULL REFERENCES work_objects(id),
  date DATE NOT NULL,
  planned_start TIMESTAMP NOT NULL,
  planned_end TIMESTAMP NOT NULL,
  lunch_minutes INTEGER NOT NULL,
  status TEXT NOT NULL DEFAULT 'planned',
  started_at TIMESTAMP,
  closed_at TIMESTAMP,
  confirmed_by INTEGER REFERENCES employees(id),
  created_at TIMESTAMP NOT NULL DEFAULT now(),
  updated_at TIMESTAMP NOT NULL DEFAULT now(),
  UNIQUE(work_object_id, date)
);
```

**–í–∞—Ä–∏–∞–Ω—Ç B:** –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ç–∞–±–ª–∏—Ü—É `shifts`
- –£–¥–∞–ª–∏—Ç—å `employee_id`
- –î–æ–±–∞–≤–∏—Ç—å `date` (–µ—Å–ª–∏ –Ω–µ—Ç)
- –ò–∑–º–µ–Ω–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã

**–†–µ—à–µ–Ω–∏–µ:** –í—ã–±—Ä–∞—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç A –∏–ª–∏ B (—Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è)

---

### ‚ö†Ô∏è 11.2 –¢—Ä–∏–≥–≥–µ—Ä—ã —Å–º–µ–Ω

**–í–æ–ø—Ä–æ—Å:** –ö–∞–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è –Ω–∞—á–∞–ª–∞/–æ–∫–æ–Ω—á–∞–Ω–∏—è —Å–º–µ–Ω?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**
- **A:** Cron job (node-cron) - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
- **B:** PostgreSQL cron (pg_cron) - —Ç—Ä–∏–≥–≥–µ—Ä—ã –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î
- **C:** –í–Ω–µ—à–Ω–∏–π —Å–µ—Ä–≤–∏—Å (–æ—Ç–¥–µ–ª—å–Ω—ã–π worker)

**–†–µ—à–µ–Ω–∏–µ:** –í—ã–±—Ä–∞—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç (—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: A - node-cron)

---

### ‚ö†Ô∏è 11.3 Timezone –æ–±—ä–µ–∫—Ç–æ–≤

**–í–æ–ø—Ä–æ—Å:** –ö–∞–∫ —Ö—Ä–∞–Ω–∏—Ç—å –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å timezone?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**
- **A:** TEXT –ø–æ–ª–µ —Å IANA timezone (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'Europe/Moscow')
- **B:** INTEGER offset –æ—Ç UTC (–º–∏–Ω—É—Ç—ã)
- **C:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, `date-fns-tz`)

**–†–µ—à–µ–Ω–∏–µ:** –í—ã–±—Ä–∞—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç (—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: A)

---

### ‚ö†Ô∏è 11.4 Ref-—Å—Å—ã–ª–∫–∏ —Ñ–æ—Ä–º–∞—Ç

**–í–æ–ø—Ä–æ—Å:** –ö–∞–∫–æ–π —Ñ–æ—Ä–º–∞—Ç URL –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ ref-—Å—Å—ã–ª–∫–∏?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**
- **A:** `/start?ref=TOKEN` (query parameter)
- **B:** `/ref/TOKEN` (path parameter)
- **C:** Deep link `t.me/botname?start=ref-TOKEN`

**–†–µ—à–µ–Ω–∏–µ:** –í—ã–±—Ä–∞—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç (—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: C - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π Telegram deep link)

---

## 12. –í–û–ü–†–û–°–´ –î–õ–Ø –£–¢–û–ß–ù–ï–ù–ò–Ø

1. **–¢—Ä–∏–≥–≥–µ—Ä—ã —Å–º–µ–Ω:** –ö–∞–∫ —á–∞—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å? (–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ: –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É)
2. **Timezone:** –ö–∞–∫ –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å timezone –æ–±—ä–µ–∫—Ç–∞? (–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ: –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏, IANA format)
3. **Ref-—Å—Å—ã–ª–∫–∏:** –ö–∞–∫–æ–π —Ñ–æ—Ä–º–∞—Ç? (–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ: Telegram deep link `t.me/botname?start=ref-TOKEN`)
4. **–î–≤–æ–π–Ω–∞—è —Ä–æ–ª—å:** Manager –º–æ–∂–µ—Ç –±—ã—Ç—å Employee? (–¥–∞, –ø–æ –¢–ó)
5. **–ê—Ä—Ö–∏–≤–∞—Ü–∏—è:** –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å –∞—Ä—Ö–∏–≤–Ω—ã–º–∏ –æ–±—ä–µ–∫—Ç–∞–º–∏? (–Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –≤ —Å–ø–∏—Å–∫–∞—Ö, –Ω–æ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è)
6. **–ú–æ–¥–µ–ª—å —Å–º–µ–Ω:** –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É –∏–ª–∏ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é? (—Ç—Ä–µ–±—É–µ—Ç —Ä–µ—à–µ–Ω–∏—è)

---

## 13. –ü–†–ò–û–†–ò–¢–ï–¢–´ –ò –ó–ê–í–ò–°–ò–ú–û–°–¢–ò

### –ë–ª–æ–∫–µ—Ä 1: –†–µ—à–µ–Ω–∏–µ –ø–æ –º–æ–¥–µ–ª–∏ —Å–º–µ–Ω
- ‚ùå –ù–µ–ª—å–∑—è –Ω–∞—á–∏–Ω–∞—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É `ShiftRepository` –±–µ–∑ —Ä–µ—à–µ–Ω–∏—è
- ‚ùå –ù–µ–ª—å–∑—è —Å–æ–∑–¥–∞–≤–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –±–µ–∑ —Ä–µ—à–µ–Ω–∏—è

### –ë–ª–æ–∫–µ—Ä 2: –†–µ—à–µ–Ω–∏–µ –ø–æ —Ç—Ä–∏–≥–≥–µ—Ä–∞–º
- ‚ùå –ù–µ–ª—å–∑—è —Ä–µ–∞–ª–∏–∑–æ–≤—ã–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –±–µ–∑ —Ä–µ—à–µ–Ω–∏—è

### –ù–µ –±–ª–æ–∫–µ—Ä, –Ω–æ –≤–∞–∂–Ω–æ:
- Timezone: –º–æ–∂–Ω–æ –Ω–∞—á–∞—Ç—å —Å UTC, –ø–æ—Ç–æ–º –¥–æ–±–∞–≤–∏—Ç—å
- Ref-—Å—Å—ã–ª–∫–∏: –º–æ–∂–Ω–æ –Ω–∞—á–∞—Ç—å —Å –ø—Ä–æ—Å—Ç–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞, –ø–æ—Ç–æ–º —É–ª—É—á—à–∏—Ç—å

---

**–ö–æ–Ω–µ—Ü –¥–æ–∫—É–º–µ–Ω—Ç–∞**

